--@name Beggar's Bazooka
--@author plonk
--@shared
--Functions - Server
if SERVER then
    enableHud(owner(), true)
    RocketDamage = 375
    ammo = 0
    canLoad = true
    canShoot = true
    overload = false
    loadState = 0
    hook.add("tick", "main", function()
        --if owner():getJumpPower() != 300 then owner():setJumpPower(300) end
        if string.endsWith(tostring(owner():getActiveWeapon()),"none]") and not owner():inVehicle() then
            local function Shoot()
                local P = hologram.create(owner():getEyePos() + Vector(0, -10, -5):getRotated(owner():getEyeAngles()), (owner():getEyeTrace().HitPos-owner():getEyePos()):getAngle(), "models/weapons/w_models/w_rocket.mdl", Vector(0.5))
                P:setAngles(P:getAngles() + Angle(math.random(-1.5, 1.5),math.random(-1.5, 1.5),math.random(-1.5, 1.5)))
                local T = hologram.create(P:getPos(), P:getAngles(), "models/buildables/sentry3_rockets.mdl", Vector(0.5))
                T:setParent(P)
                T:setLocalPos(Vector())
                T:setLocalAngles(Angle())
                CreateProj(P, 1400, 0, RocketDamage, 10, DAMAGE.BLAST, nil, false)
                owner():emitSound("weapons/doom_rocket_launcher.wav", 75, math.random(90,110), 1, 0)
                net.start("playerFired")
                net.send()
            end
            if owner():keyDown(IN_KEY.ATTACK) and canLoad then
                local function overloadExplode()
                    net.start("sendExp")
                    net.writeVector(owner():getAttachment(owner():lookupAttachment("anim_attachment_RH")))
                    net.send()
                    game.blastDamage(owner():getAttachment(owner():lookupAttachment("anim_attachment_RH")), 100, owner():getMaxHealth()/6.67)
                    local mult = 1
                    if owner():isCrouching() then mult = 2 end
                    owner():setVelocity(Vector(0, 350*mult, 0):getRotated(owner():getEyeAngles())+Vector(0,0,250*mult))
                end
                local function TryLoadMissle()
                    timer.simple(0.33, function()
                        canShoot = true
                        if owner():keyDown(IN_KEY.ATTACK) or ammoAtTheTimeOfStartingLoad+1 < 4 then
                            if not overload then
                                if ammoAtTheTimeOfStartingLoad + 1 < 4 then
                                    ammo = ammo + 1
                                    owner():emitSound("weapons/dumpster_rocket_reload.wav", 75, 67 + 11*ammo, 1, 0)
                                else
                                    overload = true
                                    ammo = ammo - 1
                                    overloadExplode()
                                end
                            else
                                ammo = ammo - 1
                                overloadExplode()
                                if ammo == 0 then overload = false net.start("playerStopLoad") net.send(owner()) end
                            end
                        end
                    end)
                end
                canLoad = false
                ammoAtTheTimeOfStartingLoad = ammo
                canShoot = false
                if loadState == 1 then
                    TryLoadMissle()
                end 
                net.start("playerLoad")
                net.writeUInt(loadState, 1)
                net.send()
                if loadState == 1 then
                timer.simple(1, function() canLoad = true end)
                else
                timer.simple(0.55, function()
                loadState = 1 
                net.start("playerLoad")
                net.writeUInt(loadState, 1)
                net.send()
                TryLoadMissle()
                timer.simple(1, function() canLoad = true end)
                end)
                end
            end
            if !owner():keyDown(IN_KEY.ATTACK) then overload = false loadState = 0 end
            if not owner():keyDown(IN_KEY.ATTACK) and ammo > 0 and canShoot then
                Shoot()
                loadState = 0
                canShoot = false
                ammo = ammo - 1
                timer.simple(0.25, function() canShoot = true end)
            end
        else
            if ammo != 0 then
                ammo = 0
                canShoot = true
                overload = false
                canLoad = true
            end
        end
    end)
end
--Functions - Projectiles
if SERVER then
    Projs = {}
    Trcr = {}
    maxQ = 0.5
    
    function Projectile()
        local I = 0
        local function rm() if Projs[I] != nil then if Projs[I][7] != nil and Projs[I][6] != "" then  PlayProjectileSound(Projs[I][7], Projs[I][1]:getPos()) end Projs[I][1]:remove() end table.remove(Projs, I) I = I - 1 end
        while I < table.count(Projs) and chip():getQuotaUsed() < chip():getQuotaMax()*maxQ do
            if chip():getQuotaUsed() < chip():getQuotaMax()*maxQ then
                I = I + 1
                local data = Projs[I]
                if data == nil then table.remove(Projs, I) I = I - 1 end
                if data != nil then
                    if data[10] == nil then data[10] = Vector() else data[10] = data[10] + Vector(0,0,-data[3]*game.getTickInterval()) end
                    data[1]:setPos(data[1]:getPos() + Vector(data[2]*game.getTickInterval(),0,0):getRotated(data[1]:getAngles()) + data[10]*game.getTickInterval())
                    local Tr = trace.line(data[1]:getPos() - Vector(data[2]*game.getTickInterval(),0,0):getRotated(data[1]:getAngles()), data[1]:getPos(),{owner(), chip()}, nil, "COLLISION_GROUP.PLAYER", nil)
                    if data[6] != DAMAGE.BLAST then
                        if Tr.Hit and cn(Tr.Entity) and hasPermission("entities.applyDamage", Tr.Entity) then
                            Tr.Entity:applyDamage(data[4], owner(), data[1], data[6], data[1]:getPos())
                        end
                    end
                    if Tr.Hit then if data[6] != DAMAGE.BLAST then 
                        game.bulletDamage(data[1]:getPos() - Vector(data[2]*game.getTickInterval(),0,0):getRotated(data[1]:getAngles()), Vector(1,0,0):getRotated(data[1]:getAngles()), 1, 1, 1000, 50, nil, 1, owner(), nil) 
                        else
                    game.blastDamage(Tr.HitPos, 200, data[4]) 
                    if data[8] then local p = prop.create(Tr.HitPos, Angle(), "models/props_phx/misc/potato_launcher_explosive.mdl", true) p:breakEnt() else
                        local eff = effect.create()
                        --eff:setOrigin(Tr.HitPos)
                        --eff:play("Explosion")
                        net.start("sendExp")
                        net.writeVector(Tr.HitPos)
                        net.send()
                        end end rm() end
                        
                    data[5] = data[5] - game.getTickInterval()
                    if data[5] <= 0 then rm() end
                end
            end
        end
    end
    
    function CreateProj(e, speed, grav, damage, lifetime, dmtype, snd, makeProp)
        if makeProp == nil then makeProp = true end
        table.add(Projs, {{e, speed, grav, damage, lifetime, dmtype, snd, makeProp}})
    end
    
    function Fire(pos, ang, endPos, len, dam, adddam, type, col)
        if ang == nil then ang = (endPos-pos):getAngle() end
        local Tr = trace.line(pos, pos + Vector(len,0,0):getRotated(ang), {chip(), owner()}, nil, "COLLISION_GROUP.PLAYER", false)
        if Tr.Hit and cn(Tr.Entity) and hasPermission("entities.applyDamage", Tr.Entity) and adddam != nil then
        local Dist = Tr.HitPos:getDistance(pos)
        if Dist >= adddam[2] then adddam[1] = adddam[1] - (Dist - adddam[2])/adddam[3] end
        Tr.Entity:applyDamage(adddam[1], owner(), owner(), type, Tr.HitPos) 
        end
        if Tr.Hit then
            local Tracer = CreateTracer(pos, (pos-Tr.HitPos):getAngle()-Angle(180,0,0), 0.125*5, Tr.HitPos:getDistance(pos), col)
            local Dist = Tr.HitPos:getDistance(pos)
            if dam != nil then
                if Dist >= dam[2] then dam[1] = dam[1] - (Dist - dam[2])/dam[3] end
                game.bulletDamage(pos, Vector(1,0,0):getRotated(ang), dam[1], 1, 100, len, nil, 1, owner(), nil)
            end
            return Tracer
        else
            local Tracer = CreateTracer(pos, ang, 0.125*5, len, col)
            return Tracer
        end
    end
    
    function Tracer()
        local I = 0
        local function rm() table.remove(Trcr, I) I = I - 1 end
        while I < table.count(Trcr) do
            I = I + 1 
            local Data = Trcr[I]
            if Data != nil then
            if not cn(Data[1]) then rm() else if hasPermission("entities.remove", Data[1]) then
            Data[2] = Data[2] - game.getTickInterval()*Data[4]
            if Data[2] <= 0 then Data[1]:remove() rm() end 
            Data[1]:setScale(Vector(Data[2]*Data[3], Data[2]*Data[3], math.lerp(Data[6], Data[1]:getScale().z, Data[5])))
            end
            end end
        end
    end
    
    function CreateTracer(pos, ang, width, len, col, sloss, lenSpeed)
        local A = hologram.create(pos, ang, "models/hunter/tubes/tube1x1x2.mdl", Vector(0))
        local Tr = hologram.create(pos, ang, "models/hunter/tubes/tube1x1x2.mdl", Vector(width, width, (len+1)/95))
        Tr:setParent(A)
        Tr:setLocalAngles(Angle(90,0,0))
        Tr:setParent(nil)
        A:remove()
        Tr:suppressEngineLighting(true)
        Tr:setColor(col)
        Tr:setMaterial("models/debug/debugwhite")
        if sloss == nil then sloss = 1 end
        if lenSpeed == nil then lenSpeed = 0.15 end
        table.add(Trcr, {{Tr, 1, width, sloss, Tr:getScale().z, lenSpeed}})
        Tr:setScale(Vector(width, width, 0))
        return Tr
    end
    
    function PlayProjectileSound(snd, pos)
        local ply = hologram.create(pos, Angle(), "models/sprops/misc/bone_from_x.mdl", Vector(0))
        ply:emitSound(snd, 75, math.random(90, 110), 1, 1)
        timer.simple(1, function()ply:remove()end)
    end

    hook.add("Tick", "proj-think-weapon-swap", function()
        Projectile()
        Tracer()
    end)
end
--Functions - Client 
if CLIENT then
    
    players = find.allPlayers()
    holdTypes = {
        --[player] = {holdtype, int}
    }
    function SetHoldType(player, holdtype)
        if holdTypes[player] == nil or holdTypes[player][1] != holdtype then
            holdTypes[player] = {holdtype, 0}
        end
    end
    function ReSetHoldType(player)
        player:resetGesture(1)
        if holdTypes[player] != nil then
        table.removeByValue(holdTypes, holdTypes[player])
        end
    end
    hook.add("PlayerConnect", "", function(networkid, name, userid, isbot) local tbl = find.playersByName(name, casesensitive, exact) if tbl != nil and tbl[1] != nil and tbl[1]:isPlayer() then table.add(players, {tbl[1]}) end end)
    hook.add("PlayerDisconnect", "", function(networkid, name, userid, isbot) local I = 0 while I < table.count(players) do I = I + 1 if players[I] == nil then table.remove(players, I) I = I - 1 end end end)
    hook.add("think", "thinker", function()
        local I = 0
        while I < table.count(players) do I = I + 1
            local p = players[I]
            if player() == owner() or p == owner() then
                if holdTypes[players[I]] != nil then
                    if p:getWaterLevel() < 1 then
                        if not p:isCrouching() then
                            if p:isOnGround() and p:getVelocity():setZ(0):getLength() < 10 and holdTypes[players[I]][2] != 1 then
                            p:resetGesture(1)
                            p:playGesture("Idle_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 1
                            end
                            if p:isOnGround() and p:getVelocity():setZ(0):getLength() >= 10 and holdTypes[players[I]][2] != 2 then
                            p:resetGesture(1)
                            p:playGesture("Run_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 2
                            end
                        else
                            if p:isOnGround() and p:getVelocity():setZ(0):getLength() < 10 and holdTypes[players[I]][2] != 3 then
                            p:resetGesture(1)
                            p:playGesture("Cidle_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 3
                            end
                            if p:isOnGround() and p:getVelocity():setZ(0):getLength() >= 10 and holdTypes[players[I]][2] != 4 then
                            p:resetGesture(1)
                            p:playGesture("CWalk_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 4
                            end
                        end
                        if !p:isOnGround() and holdTypes[players[I]][2] != 5 then
                            p:resetGesture(1)
                            p:playGesture("Jump_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 5
                        end
                    else
                        if p:getVelocity():setZ(0):getLength() < 10 and holdTypes[players[I]][2] != 6 then
                            p:resetGesture(1)
                            p:playGesture("Swim_Idle_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 6
                        end
                        if  p:getVelocity():setZ(0):getLength() >= 10 and holdTypes[players[I]][2] != 7 then
                            p:resetGesture(1)
                            p:playGesture("Swimming_"..holdTypes[players[I]][1], true, 1, 1)
                            holdTypes[players[I]][2] = 7
                        end
                    end
                end
            end
        end
    end)
    hook.add("Removed", "", function() 
        local I = 0
        while I < table.count(players) do I = I + 1
            local p = find.playersByName(players[I], true, true)[1]
            ReSetHoldType(p)
        end
    end)
    
    net.receive("sendExp", function()
        local H = hologram.create(net.readVector(), Angle(), "models/hunter/plates/plate.mdl", Vector(0))
        local P = particleEffect.attach(H, "ExplosionCore_MidAir", 0, {})
        H:emitSound("weapons/explode1.wav", 75, math.random(90,110), 0.75, 0)
        timer.simple(2, function() P:destroy() H:remove() end)
    end)   
    net.receive("playerFired", function()
        owner():resetGesture(2)
        owner():playGesture("Range_Shotgun", false, 2, 1)
        if vmHolo != nil and vmHolo:isValid() then
            vmHolo:setAnimation("Fire", 0, 1)
        end
    end) 
    net.receive("playerLoad", function()
        owner():resetGesture(2)
        owner():playGesture("Reload_Pistol", false, 2, 1)
        if vmHolo != nil and vmHolo:isValid() then
            if net.readUInt(1) == 0 then
                vmHolo:setAnimation("Reload_Start", 0, 1)
            else
                vmHolo:setAnimation("Reload_Loop", 0, 0.75)
            end
        end
    end)
    net.receive("playerStopLoad", function()
        if vmHolo != nil and vmHolo:isValid() then
            vmHolo:setAnimation("Idle", 0, 1)
        end
    end)
    camEnabled = false
    if player() == owner() then
        hook.add("calcview", "view calc", function()
            if camEnabled then
            local Tr = trace.line(owner():getEyePos(), owner():getEyePos()+(Vector(-150,-50,32.5)*0.5):getRotated(owner():getEyeAngles()), {owner(), chip()}, nil, "COLLISION.GROUP_PLAYER", nil)
            local rotatevec = Vector(0)
            if Tr.Hit then
            rotatevec = Tr.HitPos-(Vector(-150,-50,32.5)/10):getRotated(owner():getEyeAngles())  
            else
            rotatevec = owner():getEyePos()+(Vector(-150,-50,32.5)*0.5):getRotated(owner():getEyeAngles())
            end
            local Tr2 = trace.line(owner():getEyePos(), owner():getEyePos()+Vector(10000,0,0):getRotated(owner():getEyeAngles()), {owner(), chip()}, nil, "COLLISION.GROUP_PLAYER", nil)
            local angle = Angle(0)
            if Tr2.Hit then
            angle = (Tr2.HitPos-rotatevec):getAngle()
            else
            angle = owner():getEyeAngles()
            end
            
            local drawViewer = true
            
            if rotatevec:getDistance(owner():getEyePos()) < 25 then drawViewer = false end
            
            local view = {
                origin = rotatevec,
                angles = angle,
                drawviewer = drawViewer
            }
            return view 
            else
                local view = {
                origin = owner():getEyePos(),
                angles = owner():getEyeAngles(),
                drawviewer = false
                }
                return view 
            end
        end)
    end
    keystate = 0
    hook.add("think", "the thinker", function()
        if string.endsWith(tostring(owner():getActiveWeapon()),"none]") and not owner():inVehicle() then
            if player() != owner() or camEnabled then
                if holo != nil and holo:isValid() then
                Pos, Ang = owner():getAttachment(owner():lookupAttachment("anim_attachment_RH"))
                holo:setPos(Pos)
                holo:setAngles(Ang)
                else
                holo = hologram.create(owner():getEyePos(), owner():getEyeAngles(), "models/workshop/weapons/c_models/c_dumpster_device/c_dumpster_device.mdl", Vector(0.75))
                holo:setParent(owner())
                end
            end
            if player() == owner() and not camEnabled and holo != nil and holo:isValid() then holo:remove() end
            SetHoldType(owner(), "Rpg")
        else
            if holo != nil and holo:isValid() then
            holo:remove() end
            ReSetHoldType(owner())
        end
        if !string.endsWith(tostring(owner():getActiveWeapon()), "none]") and camEnabled then camEnabled = false end
    end)

    if player() == owner() then
        local vmHolo2
        hook.add("think", "BazookaVMCreate", function()
            if string.endsWith(tostring(owner():getActiveWeapon()),"none]") and not owner():inVehicle() and not camEnabled then
            if vmHolo == nil or !vmHolo:isValid() then
                vmHolo = hologram.create(owner():getEyePos()+Vector(15,0,0):getRotated(owner():getEyeAngles()), owner():getEyeAngles(), "models/weapons/v_models/v_rocketlauncher_soldier.mdl", Vector(0.5))
                vmHolo:setRenderGroup(RENDERGROUP.VIEWMODEL)
                vmHolo:setAnimation("Idle", 0, 1)
                vmHolo:setSubMaterial(2, "Models/effects/vol_light001")
                vmHolo2 = hologram.create(vmHolo:getBonePosition(vmHolo:lookupBone("rl_body"))+Vector(0,0,-4.5):getRotated(vmHolo:getAngles()), vmHolo:getAngles(), "models/workshop/weapons/c_models/c_dumpster_device/c_dumpster_device.mdl", Vector(0.6))
                vmHolo2:setRenderGroup(RENDERGROUP.VIEWMODEL)
                vmHolo2:setParent(vmHolo, nil, vmHolo:lookupBone("rl_body"))
                owner():emitSound("player/taunt_workout_get_up_draw.wav", 75, 100, 1, 1)
                vmHolo:setAnimation("Draw",0,1)
            end
            else
                if vmHolo != nil and vmHolo:isValid() then vmHolo:remove() end
                if vmHolo2 != nil and vmHolo2:isValid() then vmHolo2:remove() end
            end
        end)
        hook.add("PreDrawViewModels", "BazookaVM", function() 
            if string.endsWith(tostring(owner():getActiveWeapon()),"none]") and not camEnabled and vmHolo != nil and vmHolo:isValid() then
                vmHolo:setPos(owner():getEyePos()+Vector(15,0,0):getRotated(owner():getEyeAngles()))
                vmHolo:setAngles(owner():getEyeAngles())
            end
        end)
    end
end
